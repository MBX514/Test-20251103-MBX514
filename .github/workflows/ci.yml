name: CI

on: [push, pull_request]

jobs:
  test-1ACS:
    name: Test 1ACS (Data Cleaning)
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./1ACS
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          
      - name: Cache pip packages
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: pip-1ACS-${{ runner.os }}-${{ hashFiles('1ACS/requirements.txt') }}
          
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          
      - name: Run data cleaning tests
        run: |
          python -m pytest tests/test_clean.py -v

  test-2ACS:
    name: Test 2ACS (REST API)
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./2ACS
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          
      - name: Cache pip packages
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: pip-2ACS-${{ runner.os }}-${{ hashFiles('2ACS/requirements.txt') }}
          
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          
      - name: Run API tests
        run: |
          python -m pytest tests/test_api.py -v

  test-3ACS:
    name: Test 3ACS (Docker & CI/CD)
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./3ACS
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          
      - name: Cache pip packages
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: pip-3ACS-${{ runner.os }}-${{ hashFiles('3ACS/requirements.txt') }}
          
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          
      - name: Run validation tests
        run: |
          python -m pytest tests/ -v
          
      - name: Validate Docker configuration
        run: |
          python validate_setup.py

  validate-configs:
    name: Validate Configurations
    runs-on: ubuntu-latest
    needs: [test-1ACS, test-2ACS, test-3ACS]
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Validate Dockerfile syntax
        run: |
          cd 3ACS
          if [ -f "Dockerfile" ]; then
            echo "✅ Dockerfile exists"
            head -20 Dockerfile
          else
            echo "❌ Dockerfile missing"
            exit 1
          fi
          
      - name: Validate docker-compose syntax
        run: |
          cd 3ACS
          if [ -f "docker-compose.yml" ]; then
            echo "✅ docker-compose.yml exists"
            # Basic YAML syntax check
            python -c "import yaml; yaml.safe_load(open('docker-compose.yml'))"
            echo "✅ docker-compose.yml syntax is valid"
          else
            echo "❌ docker-compose.yml missing"
            exit 1
          fi
